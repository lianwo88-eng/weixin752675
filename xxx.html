<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" id="favicon" href="" />
    <meta name="description" id="metaDescription" content="" />
    <title id="pageTitle"></title>
    <meta property="og:title" id="ogTitle" content="临时通道" />
    <meta property="og:description" id="ogDescription" content="临时通道，限时访问" />
    <meta property="og:image" id="ogImage" content="https://wxurl.qihaobao.com/01.png" />
    <meta property="og:url" content="" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcss.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- 引入Font Awesome图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 引入微信JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .loader {
                @apply animate-spin h-12 w-12 border-2 border-green-500 border-t-transparent rounded-full;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            .env-tag {
                @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mr-2 mb-2;
            }
            .expired-x {
                @apply text-red-600 text-6xl md:text-8xl font-black;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }
    </style>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        #contentFrame {
            height: 100vh;
            width: 100vw;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .expired-container {
            background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
        }
        
        /* 引导模式样式 */
        .guide-mask {
            position: fixed;
            inset: 0;
            background-color: #fff;
            z-index: 50;
            overflow-y: auto;
        }
        .loader-guide {
            width: 320px;
            margin: 50px auto 70px;
            position: relative;
        }
        .loader-guide .loading-1 {
            margin: 0 auto;
            width: 70%;
            height: 10px;
            border: 1px solid #69d2e7;
            border-radius: 10px;
            animation: turn 4s linear 1.75s infinite;
        }
        .loader-guide .loading-1:before {
            content: "";
            display: block;
            width: 0%;
            height: 100%;
            background: #69d2e7;
            box-shadow: 10px 0 15px 0 #69d2e7;
            animation: load 2s linear infinite;
        }
        .loader-guide .loading-2 {
            width: 100%;
            position: absolute;
            top: 20px;
            color: #69d2e7;
            font-size: 22px;
            text-align: center;
            animation: bounce 2s linear infinite;
        }
        @keyframes load { 0% { width: 0%; } 87.5%, 100% { width: 100%; } }
        @keyframes turn { 0% { transform: rotateY(0deg); } 6.25%, 50% { transform: rotateY(180deg); } 56.25%, 100% { transform: rotateY(360deg); } }
        @keyframes bounce { 0%,100% { top: 10px; } 12.5% { top: 30px; } }
        .guide-footer {
            text-align: center;
            margin: 60% auto 40px;
        }
        .guide-footer img {
            width: 50px;
        }
        .guide-title {
            text-align: center;
            padding: 20px 0;
        }
        .supported-envs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 20px auto;
            max-width: 80%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 加载状态 -->
    <div id="loaderContainer" class="fixed inset-0 flex flex-col justify-center items-center bg-white z-50">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-semibold text-gray-800">正在加载内容...</h1>
        <p id="loadProgress" class="text-gray-500 mt-2 text-sm">准备请求资源</p>
    </div>
    
    <!-- 内嵌模式容器 -->
    <div id="contentContainer" class="hidden fade-in">
        <iframe id="contentFrame" class="border-0 w-full h-full" 
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                title="内嵌网页内容"></iframe>
    </div>
    
    <!-- 链接过期页面 -->
    <div id="expiredContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center expired-container z-50 p-6 text-center">
        <div class="expired-x mb-6">✕</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">链接已过期</h3>
        <p id="expiryDetail" class="text-gray-600 mb-8 max-w-md">该链接的有效期已过，无法继续访问。请联系链接提供者获取最新链接。</p>
        <button id="closeBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-md transition-colors">
            关闭页面
        </button>
    </div>
    
    <!-- 二维码过期页面 -->
    <div id="qrExpiredContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <div class="text-red-500 text-6xl mb-6">❌</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">二维码已过期</h3>
        <p class="text-gray-600 mb-6 max-w-md">此二维码已超过10分钟有效期，请重新扫描最新的二维码。</p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 max-w-md">
            <p class="text-sm text-yellow-700">
                <i class="fa fa-info-circle mr-1"></i>
                二维码每10分钟自动刷新一次，请确保扫描的是最新的二维码
            </p>
        </div>
        <button id="closeQrBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-md transition-colors">
            关闭页面
        </button>
    </div>
    
    <!-- 引导模式页面 -->
    <div id="guideMask" class="guide-mask hidden">
        <header class="guide-title">
            <h1 id="guideTitle">请在浏览器中打开</h1>
            <div class="supported-envs" id="guideSupportedEnvs"></div>
        </header>
        <div class="demo">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="loader-guide">
                            <div class="loading-1"></div>
                            <div class="loading-2" id="guideHint">请点击右上角选择"在浏览器中打开"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误信息页面 -->
    <div id="errorContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <i id="errorIcon" class="fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">访问受限</h3>
        <p id="errorMessage" class="text-gray-500 mb-6">该链接不支持当前环境，请在指定应用中打开</p>
        <div class="mb-6 p-4 bg-blue-50 border border-blue-100 rounded-lg">
            <p class="text-sm text-blue-700 mb-3"><i class="fa fa-info-circle mr-1"></i> 支持的环境：</p>
            <div class="supported-envs" id="errorSupportedEnvs"></div>
        </div>
        <button id="retryBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
            重试
        </button>
    </div>

    <script>
        // 内容信息存储
        let currentContent = {
            url: '',
            title: '',
            subtitle: '', // 用于分享描述
            cover_image: '', // 用于分享图片
            method: 'embed', // 默认内嵌模式（API未返回时使用）
            services: [], // 支持的服务列表（含详情）
            serviceKeys: [] // 服务标识（用于验证）
        };
        
        // API配置
        const API_CONFIG = {
            baseUrl: 'https://wxurl.qihaobao.com/api.php',
            timeout: 10000, // 10秒超时
            qrTokenExpiry: 600 // 10分钟，与后端保持一致
        };
        
        // 1. 环境检测
        function detectCurrentEnv() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('micromessenger')) return 'wechat'; // 微信环境
            if (ua.includes('qq/') || ua.includes('qzone/')) return 'qq'; // QQ环境
            if (ua.includes('alipayclient')) return 'alipay'; // 支付宝环境
            if (ua.includes('douyin') || ua.includes('tiktok') || ua.includes('bytedance')) return 'douyin'; // 抖音环境
            if (/(chrome|safari|firefox|edge|opera|brave)/i.test(navigator.userAgent)) return 'browser'; // 浏览器环境
            return 'other'; // 其他环境
        }
        
        // 2. 提取参数（支持token和id）
        function extractParamsFromUrl() {
            const params = new URLSearchParams(window.location.search);
            let token = params.get('token');
            let id = params.get('id');
            
            // 如果没有token，尝试从URL路径中提取id
            if (!token && !id) {
                const pathMatch = window.location.href.match(/id=(\d+)|(\d+)(?=\.\w+$)/);
                if (pathMatch) id = pathMatch[1] || pathMatch[2];
            }
            
            return {
                token: token,
                id: id ? parseInt(id, 10) : null
            };
        }
        
        // 3. 验证token有效性（适配新API）
        async function validateToken(token) {
            if (!token) return { valid: false, reason: '缺少token参数' };
            
            try {
                updateLoadProgress('正在验证二维码有效性...');
                
                // 调用新API验证token
                const apiUrl = `${API_CONFIG.baseUrl}?action=get_url&token=${encodeURIComponent(token)}`;
                
                // 设置请求超时
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('验证超时')), API_CONFIG.timeout)
                );
                
                const response = await Promise.race([fetch(apiUrl), timeoutPromise]);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return { 
                        valid: true, 
                        data: result.data,
                        linkId: result.data.id
                    };
                } else {
                    // 根据错误消息判断是否是token过期
                    if (result.message && (result.message.includes('二维码已过期') || result.message.includes('token'))) {
                        return { 
                            valid: false, 
                            reason: 'token_expired',
                            message: result.message
                        };
                    } else {
                        return { 
                            valid: false, 
                            reason: 'other',
                            message: result.message
                        };
                    }
                }
            } catch (error) {
                console.error('Token验证失败:', error);
                return { 
                    valid: false, 
                    reason: 'network_error',
                    message: error.message
                };
            }
        }
        
        // 4. 通过ID获取链接信息（适配新API）
        async function getUrlById(id) {
            try {
                updateLoadProgress('正在请求资源信息...');
                
                const apiUrl = `${API_CONFIG.baseUrl}?action=get_url&id=${id}`;
                
                // 设置请求超时
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('连接超时')), API_CONFIG.timeout)
                );
                
                const response = await Promise.race([fetch(apiUrl), timeoutPromise]);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return { 
                        success: true, 
                        data: result.data
                    };
                } else {
                    throw new Error(result.message || '请求失败');
                }
            } catch (error) {
                console.error('获取链接信息失败:', error);
                throw error;
            }
        }
        
        // 5. 更新页面元数据
        function updatePageMetadata(data) {
            const title = data.title || '临时通道';
            const desc = data.subtitle || '临时通道，限时访问';
            const image = data.cover_image || 'https://wxurl.qihaobao.com/01.png';
            
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('ogTitle').content = title;
            document.getElementById('metaDescription').content = desc;
            document.getElementById('ogDescription').content = desc;
            document.getElementById('ogImage').content = image;
            document.getElementById('favicon').href = image;
            
            // 更新og:url为当前页面URL
            const ogUrl = document.querySelector('meta[property="og:url"]');
            if (ogUrl) {
                ogUrl.content = window.location.href.split('#')[0];
            }
            
            // 存储到currentContent供分享使用
            currentContent.title = title;
            currentContent.subtitle = desc;
            currentContent.cover_image = image;
        }
        
        // 6. 更新加载进度
        function updateLoadProgress(message) {
            document.getElementById('loadProgress').textContent = message;
        }
        
        // 7. 渲染支持的环境标签
        function renderEnvTags(containerId, services) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            // 环境标签样式映射
            const envStyles = {
                'wechat': 'bg-green-100 text-green-800',
                'qq': 'bg-blue-100 text-blue-800',
                'alipay': 'bg-blue-50 text-blue-600',
                'douyin': 'bg-red-100 text-red-800',
                'browser': 'bg-gray-100 text-gray-800'
            };
            // 环境图标映射
            const envIcons = {
                'wechat': 'fa-weixin',
                'qq': 'fa-qq',
                'alipay': 'fa-credit-card',
                'douyin': 'fa-music',
                'browser': 'fa-globe'
            };
            services.forEach(service => {
                const tag = document.createElement('div');
                tag.className = `env-tag ${envStyles[service.key] || 'bg-gray-100 text-gray-800'}`;
                tag.innerHTML = `<i class="fa ${service.icon || envIcons[service.key] || 'fa-globe'} mr-1"></i>${service.name}`;
                container.appendChild(tag);
            });
        }
        
        // 8. 验证当前环境是否在支持列表中（支付宝服务直接通过）
        function isEnvSupported(currentEnv, serviceKeys) {
            // 特殊处理：如果支持列表包含支付宝，直接返回true
            if (serviceKeys.includes('alipay')) {
                return true;
            }
            // 其他环境仍需正常验证
            const envMap = {
                'wechat': ['wechat'],
                'qq': ['qq'],
                'douyin': ['douyin'],
                'browser': ['browser', 'other']
            };
            return serviceKeys.some(key => envMap[key]?.includes(currentEnv));
        }
        
        // 9. 处理内嵌模式（API返回method=embed时执行）
        async function handleEmbedMode(url) {
            const contentFrame = document.getElementById('contentFrame');
            const loaderContainer = document.getElementById('loaderContainer');
            const contentContainer = document.getElementById('contentContainer');
            
            return new Promise((resolve, reject) => {
                // 超时设置（15秒）
                const timeout = setTimeout(() => {
                    reject(new Error('内容加载超时'));
                }, 15000);
                
                // 加载完成回调
                contentFrame.onload = () => {
                    clearTimeout(timeout);
                    loaderContainer.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                    resolve(true);
                };
                
                // 加载失败回调
                contentFrame.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('内容加载失败'));
                };
                
                // 设置iframe源
                updateLoadProgress('正在加载内容...');
                contentFrame.src = url;
            });
        }
        
        // 10. 处理引导模式（浏览器环境直接跳转，不检查支持列表）
        function handleRedirectMode(currentEnv, url) {
            // 浏览器环境：直接跳转目标网址（不检查支持列表）
            if (currentEnv === 'browser') {
                updateLoadProgress('检测到浏览器环境，正在跳转目标网址...');
                // 短暂延迟显示进度提示后跳转
                setTimeout(() => {
                    window.location.href = url;
                }, 600);
                return true;
            }
            
            // 微信和QQ环境：显示引导遮罩
            if (['wechat', 'qq'].includes(currentEnv)) {
                const guideMask = document.getElementById('guideMask');
                const loaderContainer = document.getElementById('loaderContainer');
                const guideHint = document.getElementById('guideHint');
                
                // 根据环境定制引导文案
                const envHints = {
                    'wechat': '请点击右上角选择"在浏览器中打开"',
                    'qq': '请点击右上角选择"用浏览器打开"'
                };
                
                // 渲染支持的环境标签（突出显示浏览器）
                renderEnvTags('guideSupportedEnvs', [
                    { key: 'browser', name: '浏览器', icon: 'fa-globe' }
                ]);
                
                // 更新引导文案
                guideHint.textContent = envHints[currentEnv];
                
                // 显示引导页，隐藏加载状态
                loaderContainer.classList.add('hidden');
                guideMask.classList.remove('hidden');
                return false;
            }
            
            // 其他环境（非微信/QQ/浏览器）：默认跳转
            updateLoadProgress('正在处理链接...');
            setTimeout(() => {
                window.location.href = url;
            }, 600);
            return true;
        }
        
        // 11. 微信分享配置 - 修复版本
        async function configureWechatShare() {
            // 仅在微信环境中执行
            if (detectCurrentEnv() !== 'wechat') return;
            
            try {
                // 获取当前页面URL（不含#及后面部分，必须与签名一致）
                const currentUrl = window.location.href.split('#')[0];
                updateLoadProgress('正在获取微信分享配置...');
                
                // 调用远程签名接口
                const apiUrl = `https://kp.vxjuejin.com/wx_signature_api.php?url=${encodeURIComponent(currentUrl)}`;
                
                // 设置接口超时（8秒）
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('签名接口超时')), 8000)
                );
                const response = await Promise.race([fetch(apiUrl), timeoutPromise]);
                
                if (!response.ok) {
                    throw new Error(`签名接口请求失败: ${response.status}`);
                }
                
                const result = await response.json();
                
                // 验证接口返回格式
                if (!result.code || result.code !== 1 || !result.data) {
                    throw new Error(`签名生成失败: ${result.msg || '未知错误'}`);
                }
                
                const { appId, timestamp, nonceStr, signature } = result.data;
                
                // 配置微信JS-SDK
                wx.config({
                    debug: false, // 生产环境关闭调试
                    appId: appId,
                    timestamp: timestamp,
                    nonceStr: nonceStr,
                    signature: signature,
                    jsApiList: [
                        'updateAppMessageShareData',  // 分享给朋友
                        'updateTimelineShareData',    // 分享到朋友圈
                        'onMenuShareAppMessage',      // 旧版分享给朋友
                        'onMenuShareTimeline'         // 旧版分享到朋友圈
                    ]
                });
                
                // 配置分享内容 - 使用固定默认值
                wx.ready(() => {
                    console.log('微信JS-SDK准备就绪，开始配置分享');
                    
                    // 新版分享API
                    wx.updateAppMessageShareData({
                        title: '临时通道', // 固定标题
                        desc: '临时通道，限时访问', // 固定描述
                        link: currentUrl, // 分享链接（当前页面URL）
                        imgUrl: 'https://wxurl.qihaobao.com/01.png', // 固定图标
                        success: () => {
                            console.log('微信朋友分享配置成功');
                        },
                        cancel: () => {
                            console.log('用户取消分享');
                        }
                    });
                    
                    wx.updateTimelineShareData({
                        title: '临时通道', // 固定标题
                        link: currentUrl,
                        imgUrl: 'https://wxurl.qihaobao.com/01.png', // 固定图标
                        success: () => {
                            console.log('微信朋友圈分享配置成功');
                        },
                        cancel: () => {
                            console.log('用户取消分享');
                        }
                    });
                    
                    // 兼容旧版API
                    wx.onMenuShareAppMessage({
                        title: '临时通道',
                        desc: '临时通道，限时访问',
                        link: currentUrl,
                        imgUrl: 'https://wxurl.qihaobao.com/01.png',
                        success: () => {
                            console.log('旧版朋友分享配置成功');
                        }
                    });
                    
                    wx.onMenuShareTimeline({
                        title: '临时通道',
                        link: currentUrl,
                        imgUrl: 'https://wxurl.qihaobao.com/01.png',
                        success: () => {
                            console.log('旧版朋友圈分享配置成功');
                        }
                    });
                    
                    console.log('微信分享配置完成');
                });
                
                // 错误处理
                wx.error((err) => {
                    console.error('微信JS-SDK配置错误:', err);
                    // 非关键错误，不阻断页面加载
                });
                
                updateLoadProgress('微信分享配置完成');
                
            } catch (error) {
                console.error('微信分享配置失败:', error);
                // 分享配置失败不影响页面主功能，仅在控制台提示
            }
        }
        
        // 12. 主逻辑：根据API返回的模式处理
        async function processContent(currentEnv) {
            const { url, method } = currentContent;
            
            // 如果是微信环境，先配置分享再处理内容展示
            if (currentEnv === 'wechat') {
                await configureWechatShare();
            }
            
            if (method === 'redirect') {
                // 引导模式：直接执行跳转逻辑，跳过环境验证
                return handleRedirectMode(currentEnv, url);
            } else {
                // 内嵌模式：保留环境验证
                if (!isEnvSupported(currentEnv, currentContent.serviceKeys)) {
                    renderEnvTags('errorSupportedEnvs', currentContent.services);
                    throw new Error('environment_mismatch');
                }
                // 正常加载iframe
                return handleEmbedMode(url);
            }
        }
        
        // 13. 加载内容主函数（支持token和id两种方式，适配新API）
        async function loadContent() {
            // 初始化DOM元素
            const loader = document.getElementById('loaderContainer');
            const errorContainer = document.getElementById('errorContainer');
            const expiredContainer = document.getElementById('expiredContainer');
            const qrExpiredContainer = document.getElementById('qrExpiredContainer');
            const [errorIcon, errorMessage] = [
                document.getElementById('errorIcon'),
                document.getElementById('errorMessage')
            ];
            const expiryDetail = document.getElementById('expiryDetail');
            
            // 重置所有状态
            loader.classList.remove('hidden');
            [errorContainer, expiredContainer, qrExpiredContainer].forEach(el => el.classList.add('hidden'));
            
            // 提取参数
            const { token, id } = extractParamsFromUrl();
            
            // 如果没有token也没有id，显示错误
            if (!token && !id) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                    errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                    errorMessage.textContent = '未找到有效的访问参数，请检查链接';
                    errorContainer.classList.remove('hidden');
                }, 500);
                return;
            }
            
            try {
                // 检测当前环境
                const currentEnv = detectCurrentEnv();
                updateLoadProgress(`检测到环境: ${getEnvName(currentEnv)}`);
                
                let result;
                
                // 如果有token，先验证token
                if (token) {
                    updateLoadProgress('正在验证二维码有效性...');
                    const tokenValidation = await validateToken(token);
                    
                    if (!tokenValidation.valid) {
                        // token无效或过期
                        if (tokenValidation.reason === 'token_expired') {
                            loader.classList.add('hidden');
                            qrExpiredContainer.classList.remove('hidden');
                            return;
                        } else {
                            throw new Error(tokenValidation.message || '二维码验证失败');
                        }
                    }
                    
                    // token验证成功，使用返回的数据
                    result = { success: true, data: tokenValidation.data };
                    updateLoadProgress('二维码验证成功，正在加载内容...');
                } else {
                    // 使用传统的ID方式，调用新API
                    result = await getUrlById(id);
                }
                
                // 处理API返回的错误
                if (!result.success) {
                    if (result.message === "该链接已过期") {
                        // 链接过期处理
                        expiryDetail.textContent = result.data?.expiry_time 
                            ? `该链接已于 ${result.data.expiry_time} 过期` 
                            : "该链接已过期，请联系提供者获取新链接";
                        loader.classList.add('hidden');
                        expiredContainer.classList.remove('hidden');
                        return;
                    }
                    // 其他错误
                    throw new Error(result.message || '请求失败');
                }
                
                // 验证内容链接是否存在
                if (!result.data?.original_url) {
                    throw new Error('未找到对应的内容链接');
                }
                
                // 存储内容信息（适配新API返回结构）
                currentContent = {
                    url: result.data.original_url,
                    title: result.data.title || '临时通道',
                    subtitle: result.data.subtitle || '临时通道，限时访问',
                    cover_image: result.data.cover_image || 'https://wxurl.qihaobao.com/01.png',
                    method: result.data.method || 'embed',
                    services: result.data.services || [],
                    serviceKeys: result.data.services?.map(s => s.key) || []
                };
                
                // 更新页面元数据
                updatePageMetadata(result.data);
                
                // 处理内容展示（环境验证移至processContent函数，仅内嵌模式验证）
                updateLoadProgress(`正在${currentContent.method === 'embed' ? '加载' : '引导'}内容...`);
                await processContent(currentEnv);
                
            } catch (error) {
                console.error('加载失败:', error);
                loader.classList.add('hidden');
                
                // 处理环境不匹配错误（仅内嵌模式可能触发）
                if (error.message === 'environment_mismatch') {
                    errorIcon.className = 'fa fa-ban text-red-500 text-5xl mb-4';
                    errorMessage.textContent = '当前环境不支持该链接';
                    errorContainer.classList.remove('hidden');
                    return;
                }
                
                // 处理其他错误
                const errorText = error.message.includes('超时') 
                    ? '操作超时，请检查网络连接' 
                    : error.message.includes('未找到') 
                        ? `未找到对应的内容` 
                        : `加载失败: ${error.message}`;
                
                errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                errorMessage.textContent = errorText;
                errorContainer.classList.remove('hidden');
            }
        }
        
        // 辅助函数：环境标识转中文名称
        function getEnvName(env) {
            const names = {
                'wechat': '微信', 
                'qq': 'QQ', 
                'alipay': '支付宝',
                'douyin': '抖音', 
                'browser': '浏览器', 
                'other': '其他环境'
            };
            return names[env] || '未知环境';
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
            // 重试按钮事件
            document.getElementById('retryBtn').addEventListener('click', loadContent);
            // 关闭按钮事件
            document.getElementById('closeBtn').addEventListener('click', () => {
                if (window.close) {
                    window.close();
                } else {
                    document.getElementById('expiredContainer').classList.add('hidden');
                }
            });
            // 二维码过期关闭按钮
            document.getElementById('closeQrBtn').addEventListener('click', () => {
                if (window.close) {
                    window.close();
                } else {
                    document.getElementById('qrExpiredContainer').classList.add('hidden');
                    // 返回到首页或显示提示
                    window.location.href = 'https://wxurl.qihaobao.com/';
                }
            });
        });
    </script>
</body>
</html>
